<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <title>Firebase:v9:Chatアプリ</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>

    <!-- コンテンツ表示画面 -->
    <div class="iPhoneBezel">

        <div class="ベゼルばこ">
            <div class="rcv_side">
                <div>friend</div>
                <div>
                    <textarea id="receiveArea" tyle="overflow: auto; height: 100px;"></textarea>
                </div>
            </div>
            <div class="snd_side">
                <div id="S_uname">you</div>
                <div>
                    <div class="hiddenBox"></div>
                    <textarea id="sendArea" style="overflow: auto; height: 100px;"></textarea>
                </div>
            </div>
            <div id="deleteBtn"><button id="delete">削除</button></div>



        </div>


        <div class="inputArea">
            <div> 名前：<input type="text" id="uname"></div>
            <div>
                <textarea id="text" cols="30" rows="10"></textarea>
                </div>
        </div>
        <div id="output" style="overflow: auto; height: 300px;">
            <button id="sndBtn">送信</button>
        </div>

        <!--/ コンテンツ表示画面 -->



        <!-- JQuery -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <!-- JQuery -->
        <!--** 以下Firebase **-->

        <script type="module">
            // Import the functions you need from the SDKs you need
            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
            import { getDatabase, ref, push, set, onChildAdded, remove, onChildRemoved }
                from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
            // TODO: Add SDKs for Firebase products that you want to use
            // https://firebase.google.com/docs/web/setup#available-libraries

            // Your web app's Firebase configuration
            const firebaseConfig = {
                apiKey: "AIzaSyCJzQSJZLC0y3jZ8MD84XzNm7rrZsyCzOo",
                authDomain: "gsdemo-af5c8.firebaseapp.com",
                projectId: "gsdemo-af5c8",
                storageBucket: "gsdemo-af5c8.appspot.com",
                messagingSenderId: "492826762005",
                appId: "1:492826762005:web:8c141469ae2ea2047b671c"
            };
            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const db = getDatabase(app); //RealtimeDBに接続
            const dbRef = ref(db, "chat"); //RealtimeDB内の"chat"を使う
            //データ登録(Click)
            $("#sndBtn").on("click", function () {
                const msg = {
                    uname: $("#uname").val(),
                    text: $("#text").val()
                };
                const id = push(dbRef);
                set(id, msg);  //データ登録完了

                //messgage送信後にテキストをクリア（初期化）
                $("#text").val("");

                //最初にデータ取得＆onSnapshotでリアルタイムにデータを取得
                onChildAdded(dbRef, function (data) {
                    const msg = data.val();    //オブジェクトデータを取得し、変数msgに代入
                    const key = data.key;      //データのユニークキー（削除や更新に使用可能）
                    const h = `<p>${msg.uname}<br>${msg.text}</p>`;
                    $(".hiddenBox").append(h); // #outputを.sendAreaに変更
                });

            });
            //データ登録(Enter)|

            $("#text").on("keydown", function (evt) {
                console.log(evt);        //e変数の中身を確認！！
                if (evt.keyCode == 13) {   //EnterKey=13
                    const msg = {
                        uname: $("#uname").val(),
                        text: $("#text").val()
                    }
                    const newPostRef = push(dbRef); //ユニークKEYを生成
                    set(newPostRef, msg);           //"chat"にユニークKEYをつけてオブジェクトデータを登録
                }
            });

            $("#deleteBtn").on('click', function () {
                remove(dbRef);
                // remove(newPostRef, msg);
                //削除したいデータのユニークキーを指定
                // const dbref = ref(db, "-OAIjV-OAIjrTAI3PmPpQ0jc2Ayu90WPbPHFyU4l");

            });




        </script>
</body>

</html>